#!/bin/bash

set -e

# ============================================================================
# USB Keyboard Layout - Interactive GUI Configuration
# Requires: gum (https://github.com/charmbracelet/gum)
# ============================================================================

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/kbd-auto-layout"
CONFIG_FILE="${CONFIG_DIR}/keyboards.yaml"
SETXKBMAP=/usr/bin/setxkbmap
XINPUT=/usr/bin/xinput
GUM=/usr/bin/gum
YQ=/usr/bin/yq

DEFAULT_MODEL="pc105"

# ============================================================================
# Helper Functions
# ============================================================================

list_keyboards_raw() {
    $XINPUT list --short | grep -i keyboard | grep -v "Virtual\|Button\|Power\|Video\|Sleep\|Consumer"
}

# Clean keyboard name: remove leading symbols and everything after tab
clean_kb_name() {
    echo "$1" | sed -e 's/^[^a-zA-Z0-9]*//' -e 's/\t.*//' -e 's/[[:space:]]*$//'
}

# Extract keyboard ID from raw xinput line
extract_kb_id() {
    echo "$1" | sed -e 's/^.*id=\([0-9]\+\).*/\1/'
}

# Get configured layout for a keyboard name (partial match)
get_kb_config() {
    local name="$1"
    if [ -x "$YQ" ] && [ -f "$CONFIG_FILE" ]; then
        $YQ -r '.keyboards[] | "\(.name)|\(.layout)|\(.variant // "")"' "$CONFIG_FILE" 2>/dev/null | while IFS='|' read -r cfg_name layout variant; do
            if [[ "$name" == *"$cfg_name"* ]]; then
                echo "$layout${variant:+ $variant}"
                return
            fi
        done
    fi
}

# List keyboards with their config status
list_keyboards() {
    while IFS= read -r line; do
        local name id config
        name=$(clean_kb_name "$line")
        id=$(extract_kb_id "$line")
        config=$(get_kb_config "$name")
        if [ -n "$config" ]; then
            printf "%s [%s] (id=%s)\n" "$name" "$config" "$id"
        else
            printf "%s (id=%s)\n" "$name" "$id"
        fi
    done < <(list_keyboards_raw)
}

apply_layout() {
    local device_id="$1"
    local layout="$2"
    local variant="$3"
    local model="$4"

    local attempts=3
    for ((i=1; i<=attempts; i++)); do
        if $SETXKBMAP -device "$device_id" -layout "$layout" -model "$model" -variant "$variant"; then
            break
        fi
        sleep 0.5
    done

    # Apply Xmodmap if exists
    if [ -f "$HOME/.Xmodmap" ]; then
        xmodmap "$HOME/.Xmodmap" 2>/dev/null || true
    fi
}

save_keyboard_config() {
    local name="$1"
    local layout="$2"
    local variant="$3"
    local model="$4"

    mkdir -p "$CONFIG_DIR"

    if [ ! -f "$CONFIG_FILE" ]; then
        cat > "$CONFIG_FILE" << EOF
# USB Keyboard Layout Configuration
defaults:
  layout: us
  variant: intl
  model: pc105

keyboards: []

notifications:
  enabled: true

xmodmap:
  enabled: true
  file: ".Xmodmap"
EOF
    fi

    if [ -x "$YQ" ]; then
        # Use -y for YAML output (required by Python yq wrapper)
        $YQ -y -i ".keyboards += [{\"name\": \"$name\", \"layout\": \"$layout\", \"variant\": \"$variant\", \"model\": \"$model\"}]" "$CONFIG_FILE"
    else
        sed -i "s/^keyboards: \[\]/keyboards:/" "$CONFIG_FILE"
        cat >> "$CONFIG_FILE" << EOF

  - name: "$name"
    layout: $layout
    variant: $variant
    model: $model
EOF
    fi
}

# List configured keyboards
list_configured_keyboards() {
    if [ -x "$YQ" ] && [ -f "$CONFIG_FILE" ]; then
        $YQ -r '.keyboards[] | "\(.name) [\(.layout) \(.variant // "")]"' "$CONFIG_FILE" 2>/dev/null
    fi
}

# Remove a keyboard from config by name
remove_keyboard_config() {
    local name="$1"
    if [ -x "$YQ" ] && [ -f "$CONFIG_FILE" ]; then
        $YQ -y -i ".keyboards |= map(select(.name != \"$name\"))" "$CONFIG_FILE"
    fi
}

simple_mode() {
    echo "=== USB Keyboard Layout Configuration ==="
    echo ""
    echo "Available keyboards:"
    list_keyboards | nl
    echo ""
    echo "This mode requires 'gum' for the full interactive experience."
    echo "Install it with: pacman -S gum"
}

# ============================================================================
# Interactive Mode
# ============================================================================

configure_keyboard() {
    local keyboards
    keyboards=$(list_keyboards)

    if [ -z "$keyboards" ]; then
        gum style --foreground 196 "No keyboards detected!"
        return 1
    fi

    echo ""
    gum style --foreground 39 "Select a keyboard:"
    local selected_keyboard
    selected_keyboard=$(echo "$keyboards" | gum choose --height 10)

    if [ -z "$selected_keyboard" ]; then
        return 1
    fi

    local kb_id
    kb_id=$(echo "$selected_keyboard" | sed -e 's/^.*(id=\([0-9]\+\)).*/\1/')
    local kb_name
    kb_name=$(echo "$selected_keyboard" | sed -e 's/ \[.*$//' -e 's/ (id=.*//')

    echo ""
    gum style --foreground 39 "Select a layout:"
    local layouts=("us - English (US)" "us intl - English (US, International)" "fr - French" "fr azerty - French (AZERTY)" "de - German" "es - Spanish" "it - Italian" "pt - Portuguese" "ru - Russian" "jp - Japanese" "kr - Korean" "cn - Chinese")
    local selected_layout
    selected_layout=$(printf '%s\n' "${layouts[@]}" | gum choose --height 12)

    if [ -z "$selected_layout" ]; then
        return 1
    fi

    local layout variant
    layout=$(echo "$selected_layout" | awk '{print $1}')
    variant=$(echo "$selected_layout" | awk '{print $2}')
    [ "$variant" = "-" ] && variant=""

    echo ""
    if gum confirm "Apply $layout ${variant:+($variant)} to $kb_name?"; then
        apply_layout "$kb_id" "$layout" "${variant:-basic}" "$DEFAULT_MODEL"
        gum style --foreground 46 "Layout applied successfully!"

        echo ""
        if gum confirm "Save this configuration for future use?"; then
            echo ""
            gum style --foreground 39 "Enter the match pattern for this keyboard:"
            gum style --foreground 245 "(This pattern will match any keyboard containing this text)"
            local match_pattern
            match_pattern=$(gum input --value "$kb_name" --width 60)
            if [ -n "$match_pattern" ]; then
                save_keyboard_config "$match_pattern" "$layout" "${variant:-basic}" "$DEFAULT_MODEL"
                gum style --foreground 46 "Configuration saved to $CONFIG_FILE"
            fi
        fi
    fi
}

remove_config_interactive() {
    local configs
    configs=$(list_configured_keyboards)

    if [ -z "$configs" ]; then
        gum style --foreground 196 "No keyboards configured!"
        return 1
    fi

    echo ""
    gum style --foreground 39 "Select a configuration to remove:"
    local selected
    selected=$(echo "$configs" | gum choose --height 10)

    if [ -z "$selected" ]; then
        return 1
    fi

    # Extract name (everything before the first [)
    local cfg_name
    cfg_name=$(echo "$selected" | sed 's/ \[.*//')

    echo ""
    if gum confirm "Remove configuration for '$cfg_name'?"; then
        remove_keyboard_config "$cfg_name"
        gum style --foreground 46 "Configuration removed!"
    fi
}

interactive_mode() {
    if [ ! -x "$GUM" ]; then
        echo "Error: gum is not installed. Install it with: pacman -S gum" >&2
        simple_mode
        return 1
    fi

    gum style \
        --border normal \
        --margin "1" \
        --padding "1" \
        --border-foreground 212 \
        "USB Keyboard Layout Configuration"

    echo ""
    local action
    action=$(gum choose "Configure keyboard" "Remove configuration" "Exit")

    case "$action" in
        "Configure keyboard")
            configure_keyboard
            ;;
        "Remove configuration")
            remove_config_interactive
            ;;
        *)
            return 0
            ;;
    esac
}

# ============================================================================
# Main
# ============================================================================

interactive_mode
